# .github/workflows/deploy.yml
name: ViewOnSvelte

on:
  push:
    branches: [main]

env:
  NODE_VERSION: "20"
  CACHE_MAX_AGE: "360000"  # 100å°æ—¶
  BUILD_DIR: "dist"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: â” Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'  # æ”¹ä¸º npm ç¼“å­˜

      - name: ğŸ“¦ Install dependencies
        run: npm install  # æ¨èä½¿ç”¨ npm ciï¼Œå®ƒæ¯” npm install æ›´å¿«æ›´å¯é 

      - name: ğŸ—ï¸ Build project
        run: npm run build  # æ”¹ä¸º npm run build

      - name: ğŸ”§ Fix SvelteKit paths
        run: |
          cd ${{ env.BUILD_DIR }}
          
          # åˆ›å»º .nojekyll æ–‡ä»¶ï¼ˆé˜²æ­¢ GitHub Pages å¿½ç•¥ä¸‹åˆ’çº¿å¼€å¤´çš„æ–‡ä»¶ï¼‰
          touch .nojekyll
          
          # ä¿®å¤ SvelteKit è·¯å¾„é—®é¢˜
          if [ -f "index.html" ]; then
            echo "ä¿®å¤ index.html ä¸­çš„è·¯å¾„..."
            sed -i 's|/_app/|./_app/|g' index.html
            sed -i 's|src="/|src="./|g' index.html
            sed -i 's|href="/|href="./|g' index.html
          fi
          
          # è®¾ç½®ç¼“å­˜å¤´ï¼ˆå¯é€‰ï¼‰
          echo "è®¾ç½®ç¼“å­˜å¤´..."
          for file in $(find . -type f \( -name "*.js" -o -name "*.css" -o -name "*.mjs" \)); do
            echo "public, max-age=${{ env.CACHE_MAX_AGE }}, immutable" > "${file}.headers"
          done

      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ${{ env.BUILD_DIR }}
          keep_files: false  # éƒ¨ç½²å‰æ¸…ç†ç›®æ ‡åˆ†æ”¯
          force_orphan: true  # å¼ºåˆ¶æ¸…ç©ºå†å²ï¼Œåªä¿ç•™å½“å‰éƒ¨ç½²
          commit_message: |
            ğŸš€ Deploy SvelteKit App
            â€¢ Commit: ${{ github.sha }}
            â€¢ Date: $(date +'%Y-%m-%d %H:%M:%S')
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'